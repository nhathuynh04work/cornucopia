generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DB_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique @db.VarChar(255)
  name      String?  @db.VarChar(255)
  avatarUrl String?  @map("avatar_url") @db.VarChar(255)
  isActive  Boolean? @default(false) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  authentication         Authentication[]
  emailVerificationToken EmailVerificationToken?
  userRole               UserRole?
  flashcardLists         FlashcardList[]
  posts                  Post[]
  studySessions          StudySession[]

  @@map("users")
}

model UserRole {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique @map("user_id")
  role      String   @db.VarChar(50)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_roles")
}

model Authentication {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  provider     String   @db.VarChar(50)
  providerId   String?  @map("provider_id") @db.VarChar(255)
  passwordHash String?  @map("password_hash") @db.VarChar(255)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerId], map: "authentication_provider_provider_id")
  @@unique([provider, userId], map: "authentication_provider_user_id")
  @@map("authentication")
}

model EmailVerificationToken {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique @map("user_id")
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @map("expires_at") @db.Timestamptz(6)
  used      Boolean? @default(false)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_verification_tokens")
}

model Media {
  id        Int      @id @default(autoincrement())
  s3Key     String   @unique @map("s3_key")
  fileType  String   @map("file_type")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  // Belongs to a Test
  testId Int?  @map("test_id")
  test   Test? @relation("TestToMedia", fields: [testId], references: [id], onDelete: Cascade)

  // Belongs to a TestItem 
  testItemId Int?      @map("test_item_id")
  testItem   TestItem? @relation("TestItemToMedia", fields: [testItemId], references: [id], onDelete: Cascade)

  @@map("media")
}

model Test {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  timeLimit   Int?     @map("time_limit")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  items TestItem[]
  media Media[]    @relation("TestToMedia")

  @@map("tests")
}

model TestItem {
  id                   Int                 @id @default(autoincrement())
  testId               Int                 @map("test_id")
  parentItemId         Int?                @map("parent_item_id")
  type                 TestItemType
  text                 String?
  answer               String?
  points               Decimal?            @default(1) @db.Decimal(5, 2)
  allowMultipleCorrect Boolean?            @default(false) @map("allow_multiple_correct")
  mediaLayout          TestItemMediaLayout @default(FULL_WIDTH_STACKED) @map("media_layout")
  sortOrder            Int?                @map("sort_order")
  createdAt            DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime            @default(now()) @map("updated_at") @db.Timestamptz(6)

  test          Test           @relation(fields: [testId], references: [id], onDelete: Cascade)
  parent        TestItem?      @relation("ItemToChildren", fields: [parentItemId], references: [id], onDelete: Cascade)
  children      TestItem[]     @relation("ItemToChildren")
  answerOptions AnswerOption[]
  media         Media[]        @relation("TestItemToMedia")

  @@map("test_items")
}

model AnswerOption {
  id        Int      @id @default(autoincrement())
  itemId    Int      @map("item_id")
  text      String?
  isCorrect Boolean? @default(false) @map("is_correct")
  sortOrder Int?     @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)

  item TestItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@map("answer_options")
}

enum TestItemType {
  group
  multiple_choice
  short_answer

  @@map("enum_test_items_type")
}

enum TestItemMediaLayout {
  // Layout 1: Text, Media, Questions stacked vertically
  FULL_WIDTH_STACKED

  // Layout 2: [Text + Media] on left, [Questions] on right
  LEFT_STACKED

  // Layout 3: [Text] on top, [Media] on left, [Questions] on right
  TEXT_TOP_MEDIA_LEFT
}

model FlashcardList {
  id            Int            @id @default(autoincrement())
  userId        Int            @map("user_id")
  title         String?
  description   String?
  createdAt     DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  flashcards    Flashcard[]
  studySessions StudySession[]

  @@unique([userId, title], map: "uq_user_title")
  @@map("flashcard_lists")
}

model Flashcard {
  id             Int             @id @default(autoincrement())
  listId         Int             @map("list_id")
  term           String?
  definition     String?
  example        String?
  imageUrl       String?         @map("image_url")
  createdAt      DateTime        @default(now()) @map("created_at") @db.Timestamptz(6)
  list           FlashcardList   @relation(fields: [listId], references: [id], onDelete: Cascade)
  sessionAnswers SessionAnswer[]

  @@map("flashcards")
}

model Topic {
  id          Int         @id @default(autoincrement())
  name        String      @unique
  slug        String      @unique
  description String?
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)
  posts       PostTopic[]

  @@map("topics")
}

model Post {
  id          Int       @id @default(autoincrement())
  authorId    Int       @map("author_id")
  title       String
  slug        String    @unique
  content     String
  status      String    @default("draft") @db.VarChar(20)
  publishedAt DateTime? @map("published_at") @db.Timestamptz(6)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  coverUrl    String?   @map("cover_url")

  author User        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  topics PostTopic[]
  // Quan hệ ngược Post -> PostChunk
  chunks PostChunk[] @relation("PostToChunks")

  @@map("posts")
}

model PostTopic {
  postId     Int      @map("post_id")
  topicId    Int      @map("topic_id")
  assignedAt DateTime @default(now()) @map("assigned_at") @db.Timestamptz(6)

  post  Post  @relation(fields: [postId], references: [id], onDelete: Cascade)
  topic Topic @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@id([postId, topicId])
  @@map("post_topics")
}

model StudySession {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  listId    Int       @map("list_id")
  startTime DateTime  @map("start_time") @db.Timestamptz(6)
  endTime   DateTime? @map("end_time") @db.Timestamptz(6)

  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  list    FlashcardList   @relation(fields: [listId], references: [id], onDelete: Cascade)
  answers SessionAnswer[]

  @@map("study_sessions")
}

model SessionAnswer {
  id          Int      @id @default(autoincrement())
  sessionId   Int      @map("session_id")
  flashcardId Int      @map("flashcard_id")
  needRevise  Boolean  @map("need_revise")
  answerTime  DateTime @default(now()) @map("answer_time") @db.Timestamptz(6)

  session   StudySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  flashcard Flashcard    @relation(fields: [flashcardId], references: [id], onDelete: Cascade)

  @@map("session_answers")
}

model PostChunk {
  id        Int      @id @default(autoincrement())
  postId    Int      @map("post_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamptz(6)
  tsv       Unsupported("tsvector")

  // Cùng tên quan hệ với phía Post
  post Post @relation("PostToChunks", fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@map("post_chunks")
}
